name: ğŸ”§ í¬ë¡¤ë§ ë³µêµ¬ ë° ë°±ì—…

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'ìˆ˜í–‰í•  ì‘ì—…'
        required: true
        type: choice
        options:
        - backup_data
        - force_crawl
        - clean_duplicates
        - sync_only
      backup_days:
        description: 'ë°±ì—…í•  ì¼ìˆ˜ (backup_data ì„ íƒì‹œ)'
        required: false
        default: '7'
        type: string

jobs:
  recovery:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë°±ì—…ìš©)
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Chrome ì„¤ì¹˜
      uses: browser-actions/setup-chrome@v1
      if: github.event.inputs.action == 'force_crawl'
    
    - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd crawler
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install webdriver-manager
    
    - name: ğŸ’¾ ë°ì´í„° ë°±ì—…
      if: github.event.inputs.action == 'backup_data'
      run: |
        echo "ğŸ’¾ ë°ì´í„° ë°±ì—… ì‹œì‘..."
        BACKUP_DATE=$(date '+%Y%m%d_%H%M%S')
        
        # ê¸°ì¡´ ë°ì´í„° ì•„ì¹´ì´ë¸Œ
        tar -czf "backup_${BACKUP_DATE}.tar.gz" data/enhanced_news/ frontend/public/data/enhanced_news/
        
        # GitHub Artifactsë¡œ ì—…ë¡œë“œí•˜ê¸° ìœ„í•´ ì¤€ë¹„
        mkdir -p backup
        mv "backup_${BACKUP_DATE}.tar.gz" backup/
        
        echo "âœ… ë°±ì—… ì™„ë£Œ: backup_${BACKUP_DATE}.tar.gz"
    
    - name: ğŸ”„ ê°•ì œ í¬ë¡¤ë§
      if: github.event.inputs.action == 'force_crawl'
      run: |
        cd crawler
        echo "ğŸ”„ ê°•ì œ í¬ë¡¤ë§ ì‹œì‘..."
        
        # ê¸°ì¡´ ë°ì´í„° ì„ì‹œ ë°±ì—…
        mv ../data/enhanced_news ../data/enhanced_news_backup_$(date +%H%M%S) || true
        mkdir -p ../data/enhanced_news
        
        # í¬ë¡¤ë§ ì‹¤í–‰
        python run_platform_keywords_crawler.py
        
        echo "âœ… ê°•ì œ í¬ë¡¤ë§ ì™„ë£Œ"
    
    - name: ğŸ§¹ ì¤‘ë³µ ë°ì´í„° ì •ë¦¬
      if: github.event.inputs.action == 'clean_duplicates'
      run: |
        cd crawler
        echo "ğŸ§¹ ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ ì‹œì‘..."
        
        python remove_duplicates.py
        
        echo "âœ… ì¤‘ë³µ ì •ë¦¬ ì™„ë£Œ"
    
    - name: ğŸ”„ ë™ê¸°í™”ë§Œ ì‹¤í–‰
      if: github.event.inputs.action == 'sync_only'
      run: |
        cd crawler
        echo "ğŸ”„ í”„ë¡ íŠ¸ì—”ë“œ ë™ê¸°í™”ë§Œ ì‹¤í–‰..."
        
        python sync_to_frontend.py --sync
        
        echo "âœ… ë™ê¸°í™” ì™„ë£Œ"
    
    - name: ğŸ“¤ ë°±ì—… íŒŒì¼ ì—…ë¡œë“œ
      if: github.event.inputs.action == 'backup_data'
      uses: actions/upload-artifact@v4
      with:
        name: nonhyeon-data-backup-${{ github.run_number }}
        path: backup/
        retention-days: 30
    
    - name: ğŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      if: github.event.inputs.action != 'backup_data'
      run: |
        git config user.name "ë…¼í˜„ë´‡"
        git config user.email "actions@github.com"
        
        git add .
        
        if ! git diff --cached --quiet; then
          CURRENT_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')
          git commit -m "ğŸ”§ ë³µêµ¬ ì‘ì—…: ${{ github.event.inputs.action }} - $CURRENT_TIME"
          git push origin main
          echo "âœ… ë³µêµ¬ ì‘ì—… ì™„ë£Œ ë° í‘¸ì‹œë¨"
        else
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi
    
    - name: ğŸ“Š ì‘ì—… ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "ğŸ”§ ================================="
        echo "ğŸ“Š ë³µêµ¬ ì‘ì—… ì‹¤í–‰ ê²°ê³¼"
        echo "ğŸ”§ ================================="
        echo "â° ì™„ë£Œ ì‹œê°„: $(TZ=Asia/Seoul date)"
        echo "ğŸ¯ ìˆ˜í–‰ ì‘ì—…: ${{ github.event.inputs.action }}"
        echo "ğŸ“ í˜„ì¬ ë°ì´í„° íŒŒì¼ ìˆ˜:"
        find data/enhanced_news/ -name "*.json" | wc -l || echo "0"
        echo "ğŸ”§ ================================="