name: ğŸ¤– ë…¼í˜„ë™ ë‰´ìŠ¤ ìë™ í¬ë¡¤ë§

on:
  # ë§¤ì¼ 05:00, 13:00, 18:00 (KST) ìë™ ì‹¤í–‰ = UTC 20:00, 04:00, 09:00
  schedule:
    - cron: '0 20 * * *'  # ë§¤ì¼ 05:00 KST (ì˜¤ì „)
    - cron: '0 4 * * *'   # ë§¤ì¼ 13:00 KST (ì˜¤í›„)
    - cron: '0 9 * * *'   # ë§¤ì¼ 18:00 KST (ì €ë…)
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      platforms:
        description: 'í¬ë¡¤ë§í•  í”Œë«í¼ (news,blog,youtube ë˜ëŠ” all)'
        required: false
        default: 'all'
        type: string
      force_push:
        description: 'ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ë„ ê°•ì œ ì»¤ë°‹'
        required: false
        default: false
        type: boolean

env:
  TIMEZONE: Asia/Seoul

jobs:
  crawl-and-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
    
    - name: ğŸ Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Chrome ë¸Œë¼ìš°ì € ì„¤ì¹˜ (Seleniumìš©)
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
    
    - name: ğŸ”§ ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        # Chrome WebDriver ìë™ ì„¤ì¹˜ë¥¼ ìœ„í•œ ì„¤ì •
        sudo apt-get update
        sudo apt-get install -y wget unzip
        
        # í•œêµ­ ì‹œê°„ëŒ€ ì„¤ì •
        sudo timedatectl set-timezone Asia/Seoul
    
    - name: ğŸ“š Python ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd crawler
        pip install --upgrade pip
        pip install -r requirements.txt
        
        # ì¶”ê°€ í•„ìš”í•œ íŒ¨í‚¤ì§€ (GitHub Actions í™˜ê²½ìš© - ìµœì‹  ë²„ì „)
        pip install webdriver-manager
    
    - name: ğŸ•’ ì‹¤í–‰ ì‹œê°„ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
      run: |
        echo "ğŸ•’ í˜„ì¬ ì‹œê°„ (UTC): $(date -u)"
        echo "ğŸ•’ í˜„ì¬ ì‹œê°„ (KST): $(TZ=Asia/Seoul date)"
        echo "ğŸ¯ í¬ë¡¤ë§ í”Œë«í¼: ${{ github.event.inputs.platforms || 'all' }}"
    
    - name: ğŸ¯ ë‰´ìŠ¤/ë¸”ë¡œê·¸/ìœ íŠœë¸Œ í¬ë¡¤ë§ ì‹¤í–‰
      id: crawling
      run: |
        cd crawler
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        export TZ=Asia/Seoul
        
        echo "ğŸš€ ë…¼í˜„ë™ ì •ë³´ í¬ë¡¤ë§ ì‹œì‘..."
        echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date)"
        
        # Python í¬ë¡¤ë§ ì‹¤í–‰ (ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼)
        python run_platform_keywords_crawler.py
        
        # í¬ë¡¤ë§ ê²°ê³¼ í™•ì¸
        if [ $? -eq 0 ]; then
          echo "âœ… í¬ë¡¤ë§ ì™„ë£Œ"
          echo "crawling_success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ í¬ë¡¤ë§ ì‹¤íŒ¨"
          echo "crawling_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # ìˆ˜ì§‘ëœ íŒŒì¼ ìˆ˜ í™•ì¸
        NEWS_COUNT=$(find ../data/enhanced_news/ -name "*_enhanced_news_*.json" | wc -l)
        echo "ğŸ“Š ìˆ˜ì§‘ëœ íŒŒì¼ ìˆ˜: $NEWS_COUNT"
        echo "news_count=$NEWS_COUNT" >> $GITHUB_OUTPUT
    
    - name: ğŸ”„ í”„ë¡ íŠ¸ì—”ë“œ ë°ì´í„° ë™ê¸°í™”
      id: sync
      if: steps.crawling.outputs.crawling_success == 'true'
      run: |
        cd crawler
        
        echo "ğŸ”„ í”„ë¡ íŠ¸ì—”ë“œ ë™ê¸°í™” ì‹œì‘..."
        python sync_to_frontend.py --sync
        
        if [ $? -eq 0 ]; then
          echo "âœ… ë™ê¸°í™” ì™„ë£Œ"
          echo "sync_success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ë™ê¸°í™” ì‹¤íŒ¨"
          echo "sync_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ğŸ“Š ë³€ê²½ì‚¬í•­ í™•ì¸
      id: changes
      if: steps.sync.outputs.sync_success == 'true'
      run: |
        # Git ìƒíƒœ í™•ì¸
        git config user.name "ë…¼í˜„ë´‡"
        git config user.email "actions@github.com"
        
        # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
        git add data/enhanced_news/ frontend/public/data/enhanced_news/
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if git diff --cached --quiet; then
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ê°ì§€ë¨"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¶œë ¥
          echo "ğŸ“‹ ë³€ê²½ëœ íŒŒì¼ë“¤:"
          git diff --cached --name-only
        fi
    
    - name: ğŸš€ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
      if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force_push == 'true'
      run: |
        # Git ì„¤ì • (push ê¶Œí•œ ì„¤ì •)
        git config --global user.name "ë…¼í˜„ë´‡"
        git config --global user.email "actions@github.com"
        git config --global --add safe.directory /github/workspace
        
        # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„± (ê¸°ì¡´ ë°°ì¹˜ íŒŒì¼ê³¼ ë™ì¼í•œ í˜•ì‹)
        CURRENT_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')
        COMMIT_MSG="ğŸ—ƒï¸ ë°ì´í„° ìë™ ë™ê¸°í™”: $CURRENT_TIME"
        
        echo "ğŸ’¾ ì»¤ë°‹ ë©”ì‹œì§€: $COMMIT_MSG"
        
        # ì»¤ë°‹ ì‹¤í–‰
        git commit -m "$COMMIT_MSG" -m "ğŸ¤– Generated with [Claude Code](https://claude.ai/code)" -m "Co-Authored-By: Claude <noreply@anthropic.com>"
        
        # í‘¸ì‹œ ì‹¤í–‰ (ì›ê²© URLì„ HTTPSë¡œ ì¬ì„¤ì •)
        echo "ğŸ”¼ ë³€ê²½ì‚¬í•­ì„ GitHubì— í‘¸ì‹œ ì¤‘..."
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push origin main
        
        echo "âœ… GitHub í‘¸ì‹œ ì™„ë£Œ!"
    
    - name: ğŸ“ˆ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "ğŸ¯ ==================================="
        echo "ğŸ“Š ë…¼í˜„ë™ ë‰´ìŠ¤ í¬ë¡¤ë§ ì‹¤í–‰ ê²°ê³¼"
        echo "ğŸ¯ ==================================="
        echo "â° ì™„ë£Œ ì‹œê°„: $(TZ=Asia/Seoul date)"
        echo "ğŸ² í¬ë¡¤ë§ ì„±ê³µ: ${{ steps.crawling.outputs.crawling_success }}"
        echo "ğŸ”„ ë™ê¸°í™” ì„±ê³µ: ${{ steps.sync.outputs.sync_success }}"
        echo "ğŸ“ ë³€ê²½ì‚¬í•­: ${{ steps.changes.outputs.has_changes }}"
        echo "ğŸ“Š ìˆ˜ì§‘ íŒŒì¼ ìˆ˜: ${{ steps.crawling.outputs.news_count }}"
        echo "ğŸ¯ ==================================="
    
    - name: âŒ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
      if: failure()
      run: |
        echo "ğŸš¨ í¬ë¡¤ë§ ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“… ì‹¤íŒ¨ ì‹œê°„: $(TZ=Asia/Seoul date)"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì„¸ìš”."