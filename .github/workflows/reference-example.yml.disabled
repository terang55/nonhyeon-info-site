# ì´ì „ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í–ˆë˜ í¬ë¡¤ë§ ìë™í™” ì˜ˆì‹œ
# íŒŒì¼ëª…ì— .disabledë¥¼ ë¶™ì—¬ì„œ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ì„¤ì •

name: ğŸ“° ë‰´ìŠ¤ ìë™ ìˆ˜ì§‘ ì‹œìŠ¤í…œ (ì°¸ê³ ìš©)

# ì´ì „ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í–ˆë˜ ì„¤ì •
on:
  schedule:
    # ë§¤ 3ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (ë” ìì£¼ ì‹¤í–‰í–ˆë˜ ê²½ìš°)
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  news-crawler:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}  # Personal Access Token ì‚¬ìš©í–ˆë˜ ê²½ìš°
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    # ì´ì „ í”„ë¡œì íŠ¸ì—ì„œëŠ” ìºì‹œë¥¼ ë” ì ê·¹ì ìœ¼ë¡œ í™œìš©
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    # Chrome ì„¤ì¹˜ (ì´ì „ ë°©ì‹)
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    # ì´ì „ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í–ˆë˜ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ë°©ì‹
    - name: Setup Environment
      run: |
        echo "CRAWL_TARGET=news" >> $GITHUB_ENV
        echo "DATA_PATH=./data" >> $GITHUB_ENV
        echo "LOG_LEVEL=INFO" >> $GITHUB_ENV
    
    # ì˜ì¡´ì„± ì„¤ì¹˜ (ì´ì „ ë°©ì‹)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium beautifulsoup4 requests pandas
        pip install webdriver-manager  # Chrome driver ìë™ ê´€ë¦¬
    
    # ì´ì „ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì‹¤í–‰ ì „ ê²€ì¦ì„ ë” ì—„ê²©í•˜ê²Œ í•¨
    - name: Validate Environment
      run: |
        python --version
        google-chrome --version
        pip list | grep selenium
    
    # í¬ë¡¤ë§ ì‹¤í–‰ (ì´ì „ í”„ë¡œì íŠ¸ ë°©ì‹)
    - name: Run Crawler
      id: crawl
      run: |
        python crawler/main.py --mode=auto --verbose
        
        # ê²°ê³¼ ê²€ì¦
        RESULT_COUNT=$(find data/ -name "*.json" | wc -l)
        echo "result_count=$RESULT_COUNT" >> $GITHUB_OUTPUT
        
        if [ $RESULT_COUNT -eq 0 ]; then
          echo "No data collected, marking as failed"
          exit 1
        fi
    
    # ì´ì „ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í–ˆë˜ ì•Œë¦¼ ì‹œìŠ¤í…œ
    - name: Notify Success
      if: success()
      run: |
        echo "âœ… í¬ë¡¤ë§ ì„±ê³µ: ${{ steps.crawl.outputs.result_count }}ê°œ íŒŒì¼ ìˆ˜ì§‘"
        # ìŠ¬ë™ ì•Œë¦¼ì´ë‚˜ ì´ë©”ì¼ ë“±ì„ ë³´ë‚´ëŠ” ë¡œì§ì´ ìˆì—ˆìŒ
    
    # ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (ì´ì „ í”„ë¡œì íŠ¸ì—ì„œ ì¤‘ìš”í•˜ê²Œ ê´€ë¦¬í–ˆë˜ ë¶€ë¶„)
    - name: Notify Failure
      if: failure()
      run: |
        echo "âŒ í¬ë¡¤ë§ ì‹¤íŒ¨ - ê´€ë¦¬ì í™•ì¸ í•„ìš”"
        # ì‹¤íŒ¨ ì‹œ ìŠ¬ë™ì´ë‚˜ ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
    
    # ì´ì „ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë°ì´í„° ì••ì¶•ë„ í•¨
    - name: Archive Data
      if: success()
      run: |
        tar -czf "news-data-$(date +%Y%m%d).tar.gz" data/
    
    # Git ì»¤ë°‹ (ì´ì „ ë°©ì‹ - ë” ìƒì„¸í•œ ë©”ì‹œì§€)
    - name: Commit Changes
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .
        git diff --staged --quiet || git commit -m "
        ğŸ“° ìë™ ë‰´ìŠ¤ ìˆ˜ì§‘: $(date '+%Y-%m-%d %H:%M:%S')
        
        ğŸ“Š ìˆ˜ì§‘ í˜„í™©:
        - íŒŒì¼ ìˆ˜: ${{ steps.crawl.outputs.result_count }}ê°œ
        - ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')
        - ì›Œí¬í”Œë¡œìš°: ${{ github.workflow }}
        
        ğŸ¤– ìë™ ìˆ˜ì§‘ ì‹œìŠ¤í…œ"
        
        git push

# ì´ì „ í”„ë¡œì íŠ¸ì—ì„œ ë°°ìš´ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ë“¤:
# 1. í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • ê´€ë¦¬
# 2. ë‹¨ê³„ë³„ ê²€ì¦ ê°•í™”
# 3. ì‹¤íŒ¨ ì‹œ ëª…í™•í•œ ë¡œê¹…
# 4. ê²°ê³¼ ë°ì´í„° ê²€ì¦
# 5. ìƒì„¸í•œ ì»¤ë°‹ ë©”ì‹œì§€
# 6. ì•Œë¦¼ ì‹œìŠ¤í…œ í†µí•©